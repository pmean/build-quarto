---
title: "Interpreting ratios after a log transformation"
author: "Steve Simon"
source: new
date: "2025-11-07"
categories:
- Blog post
tags:
- Modeling issues
format: 
  html:
    embed-resources: true
editor: source
execute: 
  error: true
  echo: true
page_update: complete
---

I was helping a student team doing an analysis of factors affecting length of stay. This is a highly skewed variable and shows the advantage of using a log transformation. I am reproducing the analysis here using an artificial dataset that very loosely approximates the actual data. This page will help with how to identify skewness, how to fit a model after a log transformation, and how to interpret the results clearly.

<!---more--->

## Load libraries

```{r}
#| label: setup
#| message: false
#| warning: false

library(broom)
library(tidyverse)
```

## Generate synthetic data

I am not going to show the code for generating an artificial dataset that behaves like the real data set. It is tedious and boring. Do take a look at the variables. In addition to los (length of stay measured in hours), I generated a set of ages for the patients, genders (1 for male, 0 for female), and acute status (1 for acute, 0 for non-acute).

I already calculated the log (base 2) for los.

```{r}
#| label: generate-data
#| echo: false

# Generating artificial data that 
# closely mirrors the original data
# is a bit  tricky. The mean and 
# standard deviation after a log base 2
# transformation are # 5.7 and 2.6. So
# compute a normal distribution based 
# on these, add in the effect of a few 
# covariates and then back transform to
# the original scale.

# Age has a slight but statistically 
# significant affect on log_los with a 
# slope on the log scale of 0.008. Age
# has a mean of 55 and a standard 
# deviation of 18. Gender has a not 
# statistically significant affect on
# log_los with males having a mean 
# which is 0.4 unit higher. Males 
# account for about 50% of the data.

# Acute status has a large and 
# statistically significant impact on
# log_los with non-acute cases being 
# smaller on average by 1.3 log units.
# Acute cases account for 95% of the
# cases.

n <- 200
data.frame(log_los=rnorm(n, mean=5.7, sd=2.6)) |>
  mutate(age=runif(n, min=20, max=90)) |>
  mutate(age=trunc(age)) |>
  mutate(log_los=log_los+(age-55)*0.008) |>
  mutate(gender=rbinom(n, 1, 0.5)) |>
  mutate(log_los=log_los+(gender-0.5)*0.4) |>
  mutate(acute=rbinom(n, 1, 0.95)) |>
  mutate(log_los=log_los+(acute-0.95)*1.3) |>
	mutate(log_los=pmax(log_los, abs(log_los))) |>
  mutate(los=2^log_los) |>
  mutate(los=trunc(los)) |>
	mutate(log_los=log2(los)) |>
  relocate(log_los, .after=los) -> d5
glimpse(d5)
```

## Descriptive statistics and graphs for los

Looking at some descriptive statistics and graphs for los, you will see how extremely skewed this variable is.

```{r}
#| label: descriptives-los

d5 |>
	summarize(
		los_mean=mean(los),
		los_median=median(los),
		los_sd=sd(los),
		los_min=min(los),
		los_max=max(los),
		n=n())
```

Notice the range, from 1 hour to `r max(d5$los)` hours which is roughly `r round(max(d5$los)/365, 1)` years. Also notice how much difference there is between the mean of the data and the median.

```{r}
#| label: los histogram

cc0 <- "Steve Simon, CC0"
d5 |>
  ggplot() +
  aes(los) +
	geom_histogram(
	  binwidth=7*24, 
	  color="black", 
	  fill="white") +
  labs(caption=cc0)
```

The histogram shows that most of the los values are small, with a few very large and extreme outliers on the high end.

```{r}
#| label: los boxplot
#| fig-width: 6
#| fig-height: 1.5

d5 |>
  ggplot() +
  aes(x=los, y=" ") +
	geom_boxplot() +
  labs(
    x="Length of stay in hours",
    y=" ",
    caption=cc0)
```

The boxplot also shows how bad the skewness is and how extreme the outliers are. 

## Try a log transformation

The log function will often fix a distribution that is skewed to the right and reduce the impact of outliers on the high end of the scale. It squeezes the large values together. The larger the value, the more the squeezing. Values on the low end will be stretched out much less and in some cases will be squeezed together. The net effect of this is to reduce the right skewness and bring the high end outliers closer to the rest of the data.

```{r}
#| label: squeeze-1
#| fig-width: 6
#| fig-height: 1.5

data.frame(
  x=c(1, 24, 7*24, 30*24, 365*24),
  labs=paste(1, c("hour", "day", "week", "month", "year")),
  y=1) |>
  mutate(log_x=log2(x)) -> time_units

time_units |>
  ggplot() +
  aes(x=x, y=y, label=labs) +
  geom_text(angle=90) + 
  scale_x_continuous(limits=c(0,2*24*365)) +
  scale_y_continuous(
    name=" ",
    breaks=1,
    labels=" ",
    limits = c(0,2))
```

```{r}
#| label: squeeze-2
#| fig-width: 6
#| fig-height: 1.5

time_units |>
  ggplot() +
  aes(x=log_x, y=y, label=labs) +
  geom_text(angle=90) +
  scale_x_continuous(limits=c(0,log2(2*24*365)))
  scale_y_continuous(
    name=" ",
    breaks=1,
    labels=" ",
    limits = c(0,2))

```
It won't help for a distribution that is skewed to the left and/or has outliers on the low end. The stretching and squeezing in this case will actually make a bad situation worse.

```{r}
#| label: descriptives-log-los

d5 |>
	summarize(
		log_los_mean=mean(log_los),
		log_los_median=median(log_los),
		log_los_sd=sd(log_los),
		log_los_min=min(log_los),
		log_los_max=max(log_los),
		n=n())
```

```{r}
#| label: log_los histogram

d5 |>
  ggplot() +
  aes(log_los) +
	geom_histogram(
	  binwidth=1, 
	  color="black", 
	  fill="white") +
  labs(
    x="Log transformation of length of stay",
    caption=cc0)
```

```{r}
#| label: log-los boxplot
#| fig-width: 6
#| fig-height: 1.5

d5 |>
  ggplot() +
  aes(x=log_los, y=" ") +
	geom_boxplot() +
  labs(
    x="Log transformation of length of stay",
    y=" ",
    caption=cc0) -> log_los_boxplot
log_los_boxplot
```

The units on the log scale are not too intuitive. With a base 2 logarithm, each unit represents a power of 2. So 5, for example, would be 2 raised to the fifth power or 32 hours. It would be better to change the scale to something more natural.

```{r}
#| label: rescale
#| fig-width: 6
#| fig-height: 1.5

los_values <- c(1, 24, 7*24, 30*24, 365*24)
los_labels <- c(
    "1 hour", 
    "1 day", 
    "1 week", 
    "1 month", 
    "1 year")

log_los_boxplot +
  scale_x_continuous(
    breaks=log2(los_values),
    labels=los_labels,
    minor_breaks=NULL)
```

This plot shows the values on the log scale that corresponds to one hour, one day, one week, one month, and one year. Notice that the gap between one hour and one day is actually wider on the log scale than the gap between one month and one year. That illustrates how the log transformation squeezes the large values together and stretches the small values apart.